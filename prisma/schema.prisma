// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  name      String?
  password  String   // Hashed password
  role      String   @default("student") // student, teacher
  mustChangePassword Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Gamification fields
  points           Int      @default(0)
  currentStreak    Int      @default(0)
  longestStreak    Int      @default(0)
  lastActivityDate DateTime?
  weeklyPoints     Int      @default(0) // Reset every week
  lastWeekRank     Int?     // Previous week's rank

  // Relations
  submissions Submission[]
  speakingSubmissions SpeakingSubmission[]
  classes     ClassEnrollment[]
  createdClasses Class[] @relation("ClassTeacher")
  achievements UserAchievement[]
  calendarEventsCreated CalendarEvent[]
  activityProgress ActivityProgress[]
  pointsLedger PointsLedger[]

  // Performance indexes
  @@index([role])
  @@index([weeklyPoints])
  @@index([role, weeklyPoints]) // Composite for leaderboard queries
}

model Class {
  id          String   @id @default(cuid())
  name        String
  description String?
  code        String   @unique // Class code for students to join
  teacher     User     @relation("ClassTeacher", fields: [teacherId], references: [id])
  teacherId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  enrollments ClassEnrollment[]
  assignments Assignment[]
  calendarEvents CalendarEvent[]

  // Performance indexes
  @@index([teacherId]) // For finding teacher's classes
}

model ClassEnrollment {
  id        String   @id @default(cuid())
  class     Class    @relation(fields: [classId], references: [id])
  classId   String
  student   User     @relation(fields: [studentId], references: [id])
  studentId String
  joinedAt  DateTime @default(now())
  
  @@unique([classId, studentId])
}

model Activity {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String   // quiz, worksheet, slides, game, guide, resource
  category    String?  // grammar, vocab, speaking, writing-reading
  level       String?  // beginner, intermediate, advanced
  content     String   // JSON content for the activity structure
  createdBy   String?  // User ID of creator (null for legacy activities)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  submissions Submission[]
  speakingSubmissions SpeakingSubmission[]
  assignments Assignment[]
  progress ActivityProgress[]
}

model ActivityProgress {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  activityId  String
  assignment  Assignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  assignmentId String?
  progress    Int      @default(0) // 0-100
  status      String   @default("in_progress") // in_progress, completed, submitted
  categoryData String?  @db.Text // JSON string for per-category tracking
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, activityId, assignmentId])
}

model SpeakingSubmission {
  id                     String   @id @default(cuid())
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                 String
  activity               Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  activityId             String
  assignment             Assignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  assignmentId           String?
  selectedPromptIds      String[] // JSON array of selected prompt IDs
  soloSentences          String[] // Array of 3 sentences
  soloFollowUpQuestions  String[] // Array of 2 follow-up questions
  soloCompletedStepIds   String[] // Array of completed solo step IDs
  speakingBestSentence   String   // Best sentence from speaking mode
  speakingCompletedStepIds String[] // Array of completed speaking step IDs
  submittedAt            DateTime @default(now())
  status                 String   @default("submitted") // submitted

  @@unique([userId, activityId, assignmentId])
}

model PointsLedger {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  points    Int
  reason    String?
  source    String?  // e.g., activity, streak, achievement, manual
  createdAt DateTime @default(now())

  // Performance indexes
  @@index([createdAt])
  @@index([userId])
  @@index([source])
  @@index([userId, createdAt]) // Composite for user-specific queries
}

model Assignment {
  id          String   @id @default(cuid())
  class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  classId     String
  activity    Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  activityId  String
  title       String?
  instructions String?
  dueDate     DateTime?
  isFeatured  Boolean  @default(false) // Featured assignments appear in "Today's Assignments"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  submissions Submission[]
  speakingSubmissions SpeakingSubmission[]
  activityProgress ActivityProgress[]

  // Performance indexes
  @@index([classId]) // For finding class assignments
  @@index([isFeatured]) // For filtering featured assignments
  @@index([dueDate]) // For sorting by due date
}

model Submission {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  activityId String
  assignment Assignment? @relation(fields: [assignmentId], references: [id], onDelete: SetNull)
  assignmentId String?
  content    String   // JSON content of the submission
  score      Int?
  feedback   String?
  status     String   @default("pending") // pending, submitted, graded
  pointsAwarded Int    @default(0) // Points earned for this submission
  completedAt DateTime? // When the submission was marked as completed/graded
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, activityId, assignmentId])
  // Performance indexes
  @@index([userId]) // For finding user submissions
  @@index([status]) // For filtering by status
  @@index([assignmentId]) // For finding assignment submissions
}

model Achievement {
  id          String   @id @default(cuid())
  name        String   // e.g., "First Steps", "Week Warrior", "Quiz Master"
  description String   // What the achievement is for
  icon        String   // Emoji or icon identifier
  type        String   // streak, points, quiz, activity
  requirement Int      // Number needed to unlock (e.g., 7 for "7-day streak")
  points      Int      @default(0) // Bonus points for earning this
  createdAt   DateTime @default(now())

  // Relations
  userAchievements UserAchievement[]
}

model CalendarEvent {
  id          String   @id @default(cuid())
  title       String
  description String?
  date        DateTime
  endDate     DateTime?
  type        String   @default("holiday") // holiday, event, reminder
  class       Class    @relation(fields: [classId], references: [id])
  classId     String
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserAchievement {
  id            String      @id @default(cuid())
  user          User        @relation(fields: [userId], references: [id])
  userId        String
  achievement   Achievement @relation(fields: [achievementId], references: [id])
  achievementId String
  earnedAt      DateTime    @default(now())

  @@unique([userId, achievementId])
}
